### Хранимые процедуры и пользовательские функции в SQL Server

В SQL Server **хранимые процедуры** и **пользовательские функции** являются важными инструментами для выполнения повторяющихся задач, инкапсуляции бизнес-логики и повышения эффективности работы с базой данных. Рассмотрим их подробно, включая создание, использование и примеры.

---

## Хранимые процедуры

### Что такое хранимая процедура?

**Хранимая процедура** (stored procedure) — это предварительно скомпилированный блок кода на языке Transact-SQL, который хранится в базе данных и может быть многократно вызван для выполнения определенных операций. Процедуры позволяют:

- Обрабатывать входные параметры и возвращать значения через выходные параметры.
- Выполнять операции с данными в базе (например, `INSERT`, `UPDATE`, `DELETE`, `SELECT`).
- Возвращать статус выполнения (успех или ошибка).

### Создание хранимой процедуры

Для создания хранимой процедуры используется команда `CREATE PROCEDURE` или сокращенно `CREATE PROC`. Общий синтаксис:

```sql
CREATE PROCEDURE <название>
    [@параметр1 Тип [= Значение_по_умолчанию] [OUT | OUTPUT],
     @параметр2 Тип [= Значение_по_умолчанию] [OUT | OUTPUT],
     ...]
AS
BEGIN
    -- Команды процедуры
END
```

**Пример 1: Простая хранимая процедура**

Создадим процедуру, которая возвращает все записи из таблицы `Employees`.

```sql
CREATE PROCEDURE GetAllEmployees
AS
BEGIN
    SELECT * FROM Employees;
END
```

**Пример 2: Процедура с входными параметрами**

Создадим процедуру для получения информации о сотруднике по его `EmployeeID`.

```sql
CREATE PROCEDURE GetEmployeeByID
    @EmployeeID INT
AS
BEGIN
    SELECT * FROM Employees WHERE EmployeeID = @EmployeeID;
END
```

**Пример 3: Процедура с выходными параметрами**

Создадим процедуру, которая добавляет нового сотрудника и возвращает сгенерированный `EmployeeID`.

```sql
CREATE PROCEDURE AddEmployee
    @FirstName NVARCHAR(50),
    @LastName NVARCHAR(50),
    @NewEmployeeID INT OUTPUT
AS
BEGIN
    INSERT INTO Employees (FirstName, LastName)
    VALUES (@FirstName, @LastName);
    
    SET @NewEmployeeID = SCOPE_IDENTITY();
END
```

### Выполнение хранимой процедуры

Для выполнения процедуры используется команда `EXECUTE` или сокращенно `EXEC`. 

**Пример 1: Вызов простой процедуры**

```sql
EXEC GetAllEmployees;
```

**Пример 2: Вызов процедуры с параметром**

```sql
EXEC GetEmployeeByID @EmployeeID = 5;
```

**Пример 3: Вызов процедуры с выходным параметром**

```sql
DECLARE @ID INT;

EXEC AddEmployee 
    @FirstName = 'Ivan', 
    @LastName = 'Ivanov', 
    @NewEmployeeID = @ID OUTPUT;

SELECT @ID AS NewEmployeeID;
```

### Удаление хранимой процедуры

Для удаления процедуры используется команда `DROP PROCEDURE` или сокращенно `DROP PROC`.

```sql
DROP PROCEDURE IF EXISTS GetEmployeeByID;
```

### Рекомендации и лучшие практики

- **Именование**: Используйте осмысленные имена без префикса `sp_`, чтобы избежать конфликтов с системными процедурами.
- **Параметры**: Определяйте значения по умолчанию для параметров, если это возможно.
- **Безопасность**: Используйте схемы (`schemas`) для организации процедур и управления доступом.
- **Обработка ошибок**: Включайте обработку ошибок внутри процедур с помощью `TRY...CATCH`.

---

## Пользовательские функции

### Что такое пользовательская функция?

**Пользовательская функция** (user-defined function) — это объект базы данных, который принимает входные параметры, выполняет определенные действия и возвращает результат. В SQL Server существуют несколько типов функций:

1. **Скалярные функции (Scalar Functions)**: Возвращают одиночное значение.
2. **Табличные функции (Table-Valued Functions)**:
   - **Inline Table-Valued Functions**: Возвращают таблицу с помощью одного оператора `SELECT`.
   - **Multi-Statement Table-Valued Functions**: Позволяют выполнять несколько операторов и возвращают таблицу.

### Создание пользовательской скалярной функции

**Синтаксис:**

```sql
CREATE FUNCTION <название> 
(
    @параметр1 Тип = Значение_по_умолчанию,
    @параметр2 Тип = Значение_по_умолчанию,
    ...
)
RETURNS Возвращаемый_Тип
AS
BEGIN
    -- Команды функции
    RETURN <значение>;
END
```

**Пример 1: Скалярная функция для вычисления полной зарплаты**

```sql
CREATE FUNCTION CalculateTotalSalary
(
    @BaseSalary DECIMAL(10,2),
    @Bonus DECIMAL(10,2) = 0
)
RETURNS DECIMAL(10,2)
AS
BEGIN
    RETURN @BaseSalary + @Bonus;
END
```

**Использование функции:**

```sql
SELECT dbo.CalculateTotalSalary(5000, 500) AS TotalSalary;
```

### Создание табличных функций

#### Inline Table-Valued Function

**Синтаксис:**

```sql
CREATE FUNCTION <название>
(
    @параметр1 Тип = Значение_по_умолчанию,
    @параметр2 Тип = Значение_по_умолчанию,
    ...
)
RETURNS TABLE
AS
RETURN
(
    SELECT столбцы
    FROM таблица
    WHERE условия
);
```

**Пример 2: Inline Table-Valued Function для получения сотрудников по отделу**

```sql
CREATE FUNCTION GetEmployeesByDepartment
(
    @DepartmentID INT
)
RETURNS TABLE
AS
RETURN
(
    SELECT EmployeeID, FirstName, LastName
    FROM Employees
    WHERE DepartmentID = @DepartmentID
);
```

**Использование функции:**

```sql
SELECT * FROM dbo.GetEmployeesByDepartment(3);
```

#### Multi-Statement Table-Valued Function

**Синтаксис:**

```sql
CREATE FUNCTION <название>
(
    @параметр1 Тип = Значение_по_умолчанию,
    @параметр2 Тип = Значение_по_умолчанию,
    ...
)
RETURNS @таблица TABLE
(
    Столбец1 Тип,
    Столбец2 Тип,
    ...
)
AS
BEGIN
    -- Команды для заполнения @таблица
    INSERT INTO @таблица
    SELECT столбцы FROM таблица WHERE условия;

    -- Дополнительные операции
    RETURN;
END
```

**Пример 3: Multi-Statement Table-Valued Function для получения сотрудников с фильтрацией и дополнительной информацией**

```sql
CREATE FUNCTION GetDetailedEmployees
(
    @DepartmentID INT
)
RETURNS @EmployeeDetails TABLE
(
    EmployeeID INT,
    FullName NVARCHAR(100),
    DepartmentName NVARCHAR(100)
)
AS
BEGIN
    INSERT INTO @EmployeeDetails
    SELECT 
        e.EmployeeID,
        CONCAT(e.FirstName, ' ', e.LastName) AS FullName,
        d.DepartmentName
    FROM Employees e
    INNER JOIN Departments d ON e.DepartmentID = d.DepartmentID
    WHERE e.DepartmentID = @DepartmentID;

    RETURN;
END
```

**Использование функции:**

```sql
SELECT * FROM dbo.GetDetailedEmployees(3);
```

### Удаление пользовательской функции

Для удаления функции используется команда `DROP FUNCTION`.

```sql
DROP FUNCTION IF EXISTS CalculateTotalSalary;
```

### Рекомендации и лучшие практики

- **Именование**: Используйте префикс, отражающий тип функции, например `fn_`, чтобы различать функции и процедуры.
- **Возврат данных**: Предпочитайте табличные функции для возврата наборов данных и скалярные функции для одиночных значений.
- **Производительность**: Inline функции обычно работают быстрее, чем Multi-Statement, поэтому используйте их, когда это возможно.
- **Безопасность**: Ограничивайте доступ к функциям аналогично процедурам через схемы и разрешения.

---

## Сравнение хранимых процедур и пользовательских функций

| **Особенность**                  | **Хранимая процедура**                       | **Пользовательская функция**                            |
|----------------------------------|----------------------------------------------|--------------------------------------------------------|
| **Возвращаемое значение**        | Может возвращать несколько наборов результатов и статус выполнения | Возвращает одно значение (скаляр) или таблицу          |
| **Использование в запросах**     | Не может быть использована напрямую в `SELECT`, `WHERE` и других операторах | Может быть использована в `SELECT`, `WHERE`, и других выражениях |
| **Транзакции и управление**      | Поддерживает транзакции и обработку ошибок    | Не поддерживает транзакции, но может использоваться внутри процедур |
| **Параметры**                    | Поддерживает входные и выходные параметры    | Поддерживает только входные параметры                  |
| **Вызов**                        | Через `EXEC` или `EXECUTE`                    | Через вызов функции в выражениях                       |

---

## Заключение

Хранимые процедуры и пользовательские функции являются мощными инструментами в SQL Server для управления данными и реализации бизнес-логики. Хранимые процедуры лучше подходят для выполнения комплексных операций с данными, включая изменения и управление транзакциями. Пользовательские функции полезны для вычислений и обработки данных, которые могут быть использованы непосредственно в SQL-запросах.

Правильное использование этих объектов способствует улучшению производительности, повышению безопасности и облегчению поддержки кода в базе данных.