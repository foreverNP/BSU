### Триггеры в MS SQL Server

**Триггер** — это специальный тип хранимой процедуры, который автоматически выполняется в ответ на определённые события в базе данных. Триггеры широко используются для обеспечения целостности данных, автоматизации бизнес-логики и защиты базы данных от нежелательных изменений.

#### Виды триггеров

1. **DML-триггеры (Data Manipulation Language)**  
   Реагируют на операции изменения данных: `INSERT`, `UPDATE`, `DELETE`.  
   - **AFTER (FOR)**: Выполняются после успешного завершения операции.
   - **INSTEAD OF**: Выполняются вместо оригинальной операции.

2. **DDL-триггеры (Data Definition Language)**  
   Реагируют на изменения структуры базы данных: создание, изменение или удаление объектов (таблиц, представлений и т.д.).

3. **Триггеры входа в систему (Logon Triggers)**  
   Срабатывают при подключении пользователя к серверу, позволяют выполнять дополнительные проверки или ограничения.

#### Создание и синтаксис триггеров DML

**Синтаксис создания триггера:**
```sql
CREATE TRIGGER <имя_триггера>
ON <имя_таблицы>
FOR | AFTER | INSTEAD OF <INSERT | UPDATE | DELETE>
AS
BEGIN
    -- команды триггера
END
```

**Примеры:**

1. **AFTER-триггер на INSERT:**
   ```sql
   CREATE TRIGGER trg_AfterInsert
   ON Employees
   AFTER INSERT
   AS
   BEGIN
       PRINT 'Новая запись добавлена в таблицу Employees.'
   END
   ```

2. **INSTEAD OF-триггер на UPDATE:**
   ```sql
   CREATE TRIGGER trg_InsteadOfUpdate
   ON Employees
   INSTEAD OF UPDATE
   AS
   BEGIN
       -- Логика замены стандартного обновления
       UPDATE Employees
       SET Name = inserted.Name
       FROM inserted
       WHERE Employees.EmployeeID = inserted.EmployeeID
   END
   ```

#### Виртуальные таблицы в триггерах

- **INSERTED**: Содержит новые данные при `INSERT` и `UPDATE`.
- **DELETED**: Содержит старые данные при `DELETE` и `UPDATE`.

**Пример использования виртуальных таблиц:**
```sql
CREATE TRIGGER trg_CheckSalary
ON Employees
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT 1 FROM inserted
        WHERE Salary < 0
    )
    BEGIN
        RAISERROR ('Зарплата не может быть отрицательной.', 16, 1)
        ROLLBACK TRANSACTION
    END
END
```

#### Управление триггерами

- **Отключение триггера:**
  ```sql
  DISABLE TRIGGER trg_AfterInsert ON Employees
  ```

- **Включение триггера:**
  ```sql
  ENABLE TRIGGER trg_AfterInsert ON Employees
  ```

- **Удаление триггера:**
  ```sql
  DROP TRIGGER trg_AfterInsert
  ```

### Транзакции в T-SQL

**Транзакция** — это единица работы с базой данных, состоящая из одного или нескольких SQL-запросов, которые выполняются как единое целое. Транзакции обеспечивают **атомарность**, **согласованность**, **изолированность** и **долговечность** (ACID).

#### Основные команды управления транзакциями

1. **BEGIN TRANSACTION**  
   Начинает новую транзакцию.

2. **COMMIT TRANSACTION**  
   Фиксирует все изменения, сделанные в рамках транзакции.

3. **ROLLBACK TRANSACTION**  
   Откатывает все изменения, сделанные в рамках транзакции.

#### Пример использования транзакции

```sql
BEGIN TRANSACTION

BEGIN TRY
    -- Операция 1: Вставка данных
    INSERT INTO Accounts (AccountName, Balance) VALUES ('Счет А', 1000)

    -- Операция 2: Обновление данных
    UPDATE Accounts SET Balance = Balance - 500 WHERE AccountName = 'Счет А'

    -- Если обе операции успешны, фиксируем транзакцию
    COMMIT TRANSACTION
    PRINT 'Транзакция успешно завершена.'
END TRY
BEGIN CATCH
    -- В случае ошибки откатываем транзакцию
    ROLLBACK TRANSACTION
    PRINT 'Произошла ошибка. Транзакция откатена.'
END CATCH
```

#### Уровни изоляции транзакций

Уровень изоляции определяет, как изменения, сделанные одной транзакцией, видны другим параллельным транзакциям. Основные уровни:

1. **READ UNCOMMITTED**  
   Позволяет читать незафиксированные изменения (грязное чтение).

2. **READ COMMITTED** (по умолчанию)  
   Гарантирует, что транзакция читает только зафиксированные данные.

3. **REPEATABLE READ**  
   Предотвращает изменение или удаление строк, которые были прочитаны в текущей транзакции.

4. **SERIALIZABLE**  
   Наиболее строгий уровень изоляции, предотвращает появление фантомных строк.

5. **SNAPSHOT**  
   Обеспечивает изолированное представление данных на момент начала транзакции.

**Установка уровня изоляции:**
```sql
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE
BEGIN TRANSACTION
    -- операции
COMMIT TRANSACTION
```

#### Управление транзакциями с использованием `SAVEPOINT`

`SAVEPOINT` позволяет устанавливать точки сохранения внутри транзакции, к которым можно откатиться без отмены всей транзакции.

**Пример:**
```sql
BEGIN TRANSACTION

SAVE TRANSACTION SavePoint1

BEGIN TRY
    -- Операция 1
    INSERT INTO Orders (OrderID, Product) VALUES (1, 'Товар А')

    -- Операция 2
    INSERT INTO Orders (OrderID, Product) VALUES (1, 'Товар Б') -- Предположим, дублирование вызывает ошибку

    COMMIT TRANSACTION
END TRY
BEGIN CATCH
    -- Откат до точки сохранения
    ROLLBACK TRANSACTION SavePoint1
    PRINT 'Произошла ошибка. Откат до SavePoint1.'
END CATCH
```

### Важные аспекты работы с транзакциями и триггерами

- **Взаимодействие триггеров и транзакций:** Триггеры выполняются в контексте текущей транзакции. Ошибка в триггере может привести к откату всей транзакции.

- **Управление блокировками:** Транзакции могут приводить к блокировкам ресурсов. Важно правильно управлять длительностью транзакций и уровнем изоляции, чтобы избежать дедлоков и повысить производительность.

- **Обработка ошибок:** Использование конструкций `TRY...CATCH` помогает эффективно управлять ошибками и откатами транзакций, обеспечивая надежность и консистентность данных.

### Заключение

Триггеры и транзакции — мощные инструменты в MS SQL Server, позволяющие автоматизировать процессы, обеспечивать целостность данных и управлять изменениями в базе данных. Правильное их использование способствует созданию надёжных и эффективных систем управления данными.